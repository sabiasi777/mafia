<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mafia Game</title>
    <link rel="stylesheet" href="../assets/css/game.css">
</head>
<body>
    <a href="http://localhost:8080" class="home-link">‚Üê Mafia</a>
    
    <div class="container">
        <div id="gameScreen" class="game-card">
            <header>
                <h1>Room: {{.Code}}</h1>
            </header>

            <div class="game-info" id="gameInfo">
                <div class="info-section">
                    <h2>Players <span class="player-count">{{len .Players}}</span></h2>
                    <ul class="player-list" id="playerList">
                        {{range .Players}}
                            <li class="player-item {{if .IsActive}}active{{end}}">{{.Name}}</li>
                        {{end}}
                    </ul>
                </div>

                {{ if .ActiveRoles }}
                    <div class="info-section">
                        <h2>Active Roles</h2>
                        <ul class="role-list" id="roleList">
                            {{range .ActiveRoles}}
                                <li class="role-item">{{.}}</li>
                            {{end}}
                        </ul>
                    </div>
                {{ else }}
                    <div class="warning">
                        ‚ö†Ô∏è Not enough players to start the game. Minimum: 4
                    </div>
                {{ end }}
            </div>

            <button class="start-button" id="startButton" type="button" disabled>
                üéÆ Start Game
            </button>

            <div class="status-bar" id="statusBar">
                Waiting for players to join...
            </div>
        </div>
    </div>

    <div id="roleContainer" class="role-reveal">
        <div class="role-text" id="roleText"></div>
    </div>

    <div id="gameArea" class="game-area">
        <div class="chat-container">
            <div id="messages" class="messages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" class="message-input" placeholder="Type your message...">
                <button id="sendButton" class="send-button">Send</button>
            </div>
        </div>
        <button id="microphoneButton" class="mic-button muted">üîá</button>
    </div>

    <script>
        const startButton = document.getElementById("startButton")
        const playerList = document.getElementById("playerList")
        const roleContainer = document.getElementById('roleContainer');
        const roleText = document.getElementById('roleText');
        const gameArea = document.getElementById('gameArea');
        const gameScreen = document.getElementById('gameScreen');
        const sendButton = document.getElementById("sendButton")
        const microphoneButton = document.getElementById("microphoneButton")
        
        var roomCode
        var ws
        var stream
        var mediaRecorder
        var chunks = []
        var micMode = false

        function checkPlayerCount() {
            const playerCount = playerList.querySelectorAll("li").length
            const countElement = document.querySelector('.player-count');
            if (countElement) {
                countElement.textContent = playerCount;
            }
            startButton.disabled = playerCount < 4
            
            if (playerCount >= 4) {
                startButton.innerHTML = 'üéÆ Start Game';
            } else {
                startButton.innerHTML = `üéÆ Need ${4 - playerCount} more players`;
            }
        }

        checkPlayerCount()

        const observer = new MutationObserver(checkPlayerCount)
        observer.observe(playerList, { childList: true })

        startButton.addEventListener('click', () => {
            roomCode = window.location.pathname.split("/").pop()
            fetch("http://localhost:8080/start", {
                method: "POST",
                headers: {
                    'Content-Type': "application/json"
                },
                body: JSON.stringify({ roomCode })
            })
            .then(res => {
                if (!res.ok) throw new Error("Failed to start game")
                return res.json()
            })
            .then(data => {
                connect()
                const currentUser = getCurrentUserNameFromURL()
                const me = data.find(p => p.name === currentUser)
                if (me) {
                    startGameUI(me)
                }
            })
            .catch(err => console.error(err))
        })

        function getCurrentUserNameFromURL() {
            const params = new URLSearchParams(window.location.search)
            return params.get("user")
        }

        function startGameUI(me) {
            document.getElementById("gameInfo").style.display = "none"
            document.getElementById("statusBar").style.display = "none"
            document.getElementsByTagName("header")[0].style.display = "none"
            startButton.style.display = "none"

            roleText.textContent = `Your role: ${me.role}`
            roleContainer.style.display = "flex"

            setTimeout(() => {
                roleContainer.style.display = "none"
                gameArea.style.display = "block"
            }, 3000)
        }

        sendButton.addEventListener("click", () => {
            const input = document.getElementById("messageInput")
            if (input.value.trim()) {
                const currentUser = getCurrentUserNameFromURL()
                const messageData = {
                    sender: currentUser,
                    content: input.value.trim(),
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    type: "text"
                }
                ws.send(JSON.stringify(messageData))
                input.value = ""
            }
        })

        document.getElementById("messageInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendButton.click()
            }
        })

        microphoneButton.addEventListener("click", sendAudio)

        function base64ToUint8Array(base64) {
            const binaryString = atob(base64)
            const len = binaryString.length
            const bytes = new Uint8Array(len)
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i)
            }
            return bytes
        }

        function connect() {
            ws = new WebSocket(`ws://localhost:8080/ws/chat?room=${roomCode}`)

            ws.onopen = function() {
                console.log("Connected to WebSocket server")
            }

            ws.onmessage = async function(event) {
                const parsed = JSON.parse(event.data)

                console.log("type of data:", typeof event.data)

                if (parsed.mimeType && parsed.audio) {
                    const audioBytes = base64ToUint8Array(parsed.audio)
                    const audioBlob = new Blob([audioBytes], { type: parsed.mimeType })
                    const audioURL = URL.createObjectURL(audioBlob)

                    const audio = new Audio(audioURL)
    
                    audio.play().catch(err => {
                        console.error("Audio playback failed:", err)
                        URL.revokeObjectURL(audioURL);
                    })

                    audio.onended = () => {
                        URL.revokeObjectURL(audioURL)
                    }
                }
                else {
                    console.log("TEXT MESSAGE!")
                    const message = JSON.parse(event.data)
                    const messageDisplay = document.getElementById("messages")
                    const messageElement = document.createElement("div")
                    messageElement.className = "message"
                    messageElement.innerHTML = `
                        <div class="message-sender">${message.sender}</div>
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${message.timestamp}</div>
                    `
                    
                    messageDisplay.appendChild(messageElement)
                    messageDisplay.scrollTop = messageDisplay.scrollHeight
                }
            }

            ws.onclose = function() {
                console.log("WebSocket connection closed, retrying...")
                setTimeout(connect, 1000)
            }

            ws.onerror = function(error) {
                console.error("WebSocket error:", error)
            }
        }

        async function sendAudio() {
            if (!stream) {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true })
            }

            if (!mediaRecorder) {
                mediaRecorder = new MediaRecorder(stream)

                mediaRecorder.ondataavailable = async (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data)

                        fetch("http://localhost:8080/audio", {
                            method: "POST",
                            headers: {
                                "Room-Code": roomCode,
                                "Content-Type": e.data.type,
                                'X-Mime-Type': e.data.type
                            },
                            body: e.data
                        })
                        .catch(err => console.error(err))
                    }
                }

                mediaRecorder.onstop = () => {
                    chunks = []
                }
            }

            toggleMicrophone()

            if(micMode) {
                mediaRecorder.start(100)
            } else {
                mediaRecorder.stop()
            }
        }

        function toggleMicrophone() {
            micMode = !micMode;
            
            if (micMode) {
                microphoneButton.className = 'mic-button unmuted';
                microphoneButton.textContent = 'üéôÔ∏è';
            } else {
                microphoneButton.className = 'mic-button muted';
                microphoneButton.textContent = 'üîá';
            }
        }

        // Add subtle floating animation to the card
        const gameCard = document.querySelector('.game-card');
        let floatDirection = 1;
        
        setInterval(() => {
            if (!gameCard.matches(':hover')) {
                const currentTransform = gameCard.style.transform.match(/translateY\(([^)]+)\)/);
                const currentY = currentTransform ? parseFloat(currentTransform[1]) : 0;
                
                if (currentY >= 2) floatDirection = -1;
                if (currentY <= -2) floatDirection = 1;
                
                gameCard.style.transform = `translateY(${currentY + (floatDirection * 0.05)}px)`;
            }
        }, 100);
    </script>
</body>
</html>